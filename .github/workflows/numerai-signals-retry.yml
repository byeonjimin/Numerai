name: numerai-signals-retry

on:
  workflow_run:
    workflows: ["numerai-signals-auto"]
    types: [completed]

permissions:
  actions: write
  contents: read

jobs:
  retry:
    if: >
      github.event.workflow_run.conclusion == 'cancelled' ||
      github.event.workflow_run.conclusion == 'failure'
    runs-on: ubuntu-latest
    steps:
      - name: Re-dispatch if under retry cap
        uses: actions/github-script@v7
        with:
          script: |
            const run = context.payload.workflow_run;
            const attempt = run.run_attempt || 1;
            const maxAttempts = 3;
            if (attempt >= maxAttempts) {
              core.info(`Skip retry: attempt ${attempt} >= ${maxAttempts}`);
              return;
            }
            core.info(`Retrying workflow (attempt ${attempt + 1}/${maxAttempts})`);
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: "numerai-signals.yml",
              ref: context.ref || run.head_branch || "main"
            });
